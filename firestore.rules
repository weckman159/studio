
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for secure, reusable logic.
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user is a member of the specified family.
    // This is the core of our multi-tenancy security.
    function isFamilyMember(familyId) {
      return isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/families/$(familyId)).data.members;
    }

    // Checks if the requesting user is the parent (admin) of the family.
    function isParent(familyId) {
      return isSignedIn() && request.auth.uid == get(/databases/$(database)/documents/families/$(familyId)).data.parentId;
    }

    // Root collection for all families.
    match /families/{familyId} {
      // Only a family member can read the family document.
      allow get: if isFamilyMember(familyId);
      // Only the parent can update the family (e.g., change name, add members via Cloud Function).
      allow write: if isParent(familyId);

      // --- Nested Child Data ---
      match /children/{childId} {
        // Any family member can read any child's data within the family.
        allow get: if isFamilyMember(familyId);

        // **ANTI-FRAUD RULE #1: No Direct Balance Writes**
        // A child cannot directly write to their own document.
        // The `totalStars` field can ONLY be changed via server-side logic (Cloud Functions/Transactions).
        // A parent can update non-critical fields like the child's name or avatar.
        allow update: if isParent(familyId);
        // Only parents can create or delete child accounts.
        allow create, delete: if isParent(familyId);
      }

      // --- Nested Task Data ---
      match /tasks/{taskId} {
        // Any family member can read tasks.
        allow read: if isFamilyMember(familyId);
        // Only parents can create, update, or delete tasks.
        allow create, update, delete: if isParent(familyId);
      }

      // --- Nested Task Completion Data (The "Anti-Cheat" Collection) ---
      match /task_completions/{completionId} {
        // A family member can see completion history.
        allow read: if isFamilyMember(familyId);

        // **ANTI-FRAUD RULE #2: Idempotent Task Completion**
        // A child can ONLY create a new completion record.
        // - They cannot create a record for another child.
        // - The document must be new (`!exists(...)`). This prevents replay attacks.
        // - The `starValue` in the record must match the `starValue` of the original task. This prevents them from saying a 10-star task gave them 100 stars.
        allow create: if isSignedIn()
                      && request.resource.data.childId == request.auth.uid
                      && !exists(/databases/$(database)/documents/families/$(familyId)/task_completions/$(completionId))
                      && request.resource.data.starValue == get(/databases/$(database)/documents/families/$(familyId)/tasks/$(request.resource.data.taskId)).data.starValue;

        // Nobody can update or delete completion history, ensuring a permanent audit trail.
        allow update, delete: if false;
      }

       // --- Nested Reward Data ---
      match /rewards/{rewardId} {
        // Any family member can read rewards.
        allow read: if isFamilyMember(familyId);
        // Only parents can create, update, or delete rewards.
        allow create, update, delete: if isParent(familyId);
      }

      // --- Nested Reward Redemption Data (For Double-Spend Prevention) ---
      match /reward_redemptions/{redemptionId} {
        // A child can ONLY create a redemption record for themselves.
        // This operation MUST be done within a TRANSACTION to prevent double-spending.
        // The rule here is a basic safeguard; the transaction is the primary defense.
        allow create: if isSignedIn() && request.resource.data.childId == request.auth.uid;
        // Nobody can alter the history.
        allow read: if isFamilyMember(familyId);
        allow update, delete: if false;
      }
    }
  }
}
