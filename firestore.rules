
rules_version = '2';

/**
 * @file firestore.rules
 * @description Security rules for the AutoSphere Firestore database.
 *
 * @section Core Philosophy
 * This ruleset enforces a strict user-ownership model. All user-specific data, such as settings,
 * cars, and posts, is private by default and can only be accessed or modified by the authenticated
 * owner. Public access to certain data, like user profiles or posts, is explicitly granted based
 * on a 'profileVisibility' flag, which is denormalized for efficient rule evaluation.
 *
 * @section Data Structure
 * - /users/{userId}: Public-facing user profile data.
 * - /users/{userId}/cars/{carId}: Private collection of a user's cars.
 * - /users/{userId}/posts/{postId}: Collection of a user's posts.
 * - /users/{userId}/posts/{postId}/comments/{commentId}: Comments on posts.
 * - /userSettings/{userId}: Strictly private user settings (notifications, privacy).
 * - /featuredCars/{date}: Public, read-only data for the 'Car of the Day'.
 *
 * @section Key Security Decisions
 * - Default Deny: All paths are closed by default. Access must be explicitly granted.
 * - User Listing Disabled: It is not possible to list all users in the application.
 * - Strict Ownership: User-generated content is managed exclusively by its owner.
 * - Structural Segregation: Private data (userSettings) is in a separate collection from
 *   potentially public data (users), enhancing security and query performance.
 *
 * @section Denormalization for Authorization
 * To avoid slow and costly 'get()' calls in rules, the `profileVisibility` setting is denormalized
 * from `/userSettings/{userId}` to `/users/{userId}`. This allows rules for posts and profiles
 * to quickly check visibility without reading a separate document.
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * Use for path-based ownership checks.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document.
     * CRITICAL: Use for all update and delete operations to prevent modifying non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * Checks if the user profile is public. Used for read access checks.
     */
    function isPublicProfile(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.profileVisibility == 'public';
    }

    /**
     * Validates that the creatorId field in a new document matches the authenticated user.
     */
    function isRequestingUser(field) {
      return isSignedIn() && request.resource.data[field] == request.auth.uid;
    }

    /**
     * Checks ownership of a document via a 'userId' field inside the document data.
     */
    function isDocumentOwner(doc) {
      return isSignedIn() && request.auth.uid == doc.userId;
    }

    // ------------------------------------------------------------------------
    // Collection: posts (Root Collection)
    // ------------------------------------------------------------------------
    /**
     * @description Manages all posts for the main feed.
     * @path /posts/{postId}
     * @allow (list) Any user, including anonymous, can read all posts.
     * @allow (get) Any user, including anonymous, can read a single post.
     * @allow (create) An authenticated user can create a post.
     * @allow (update, delete) Only the author of the post can update or delete it.
     */
    match /posts/{postId} {
      allow list, get: if true;
      allow create: if isSignedIn() && isRequestingUser('authorId');
      allow update, delete: if isSignedIn() && isDocumentOwner(resource.data);
    }
    
    // ------------------------------------------------------------------------
    // Collection: users
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile data.
     * @path /users/{userId}
     * @allow (get) An authenticated user reads another user's public profile.
     * @allow (create) A new user creates their own profile document.
     * @allow (update) An authenticated user updates their own profile.
     * @deny (list) An anonymous user tries to list all user profiles.
     * @deny (update) A user tries to update another user's profile.
     * @principle A user's profile can be read if public, but only the owner can write to it.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || (resource != null && resource.data.profileVisibility == 'public');
      allow list: if false;
      allow create: if isOwner(userId) && isRequestingUser('id');
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    // ------------------------------------------------------------------------
    // Subcollection: cars
    // ------------------------------------------------------------------------

    /**
     * @description Manages the cars in a user's garage.
     * @path /users/{userId}/cars/{carId}
     * @allow (create) An authenticated user adds a new car to their own garage.
     * @allow (list) An authenticated user lists all cars in their own garage.
     * @deny (get) A user tries to read car details from another user's garage.
     * @deny (delete) A user tries to delete a car from another user's garage.
     * @principle Enforces strict ownership. All data within a user's data tree is private to them.
     */
    match /users/{userId}/cars/{carId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    // ------------------------------------------------------------------------
    // Subcollection: posts (Deprecated - use root /posts)
    // ------------------------------------------------------------------------

    /**
     * @description Manages user-generated posts.
     * @path /users/{userId}/posts/{postId}
     * @allow (list) Any signed-in user lists posts from a public user profile.
     * @allow (create) An authenticated user creates a new post.
     * @deny (get) A user tries to read a post from a private user profile.
     * @deny (update) A user tries to edit another user's post.
     * @principle Posts can be read if the owner's profile is public, but only the owner can write.
     */
    match /users/{userId}/posts/{postId} {
      allow get: if isOwner(userId) || isPublicProfile(userId);
      allow list: if isOwner(userId) || isPublicProfile(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    // ------------------------------------------------------------------------
    // Subcollection: comments
    // ------------------------------------------------------------------------

    /**
     * @description Manages comments on posts.
     * @path /users/{userId}/posts/{postId}/comments/{commentId}
     * @allow (create) An authenticated user adds a comment to any public post.
     * @allow (update) A user edits their own comment.
     * @allow (list) Any authenticated user reads comments on a public post.
     * @deny (delete) A user tries to delete another user's comment.
     * @deny (create) An anonymous user tries to post a comment.
     * @principle Allows community interaction on public content, but users retain control of their own comments.
     */
    match /users/{userId}/posts/{postId}/comments/{commentId} {
      allow get: if isOwner(userId) || isPublicProfile(userId);
      allow list: if isOwner(userId) || isPublicProfile(userId);
      allow create: if isSignedIn() && isRequestingUser('userId') && request.resource.data.postId == postId;
      allow update: if isSignedIn() && resource != null && isDocumentOwner(resource.data) && request.resource.data.userId == resource.data.userId;
      allow delete: if isSignedIn() && resource != null && isDocumentOwner(resource.data);
    }

    // ------------------------------------------------------------------------
    // Collection: featuredCars
    // ------------------------------------------------------------------------

    /**
     * @description Stores the 'Car of the Day', which is public information.
     * @path /featuredCars/{date}
     * @allow (get) Any user, including anonymous, can view the featured car.
     * @allow (list) Any user, including anonymous, can list featured cars.
     * @deny (create) A client tries to create a new featured car entry.
     * @principle This collection is public and read-only for clients. It should be managed by a trusted backend service or admin SDK.
     */
    match /featuredCars/{date} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // ------------------------------------------------------------------------
    // Collection: userSettings
    // ------------------------------------------------------------------------

    /**
     * @description Stores private, user-specific settings for notifications and privacy.
     * @path /userSettings/{userId}
     * @allow (get) An authenticated user reads their own settings.
     * @allow (update) An authenticated user updates their own settings.
     * @deny (get) A user attempts to read another user's settings.
     * @deny (list) A user attempts to list all settings documents.
     * @principle Enforces strict ownership for sensitive user data. This data is never publicly accessible.
     */
    match /userSettings/{userId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
    
    // ------------------------------------------------------------------------
    // Collection: votings
    // ------------------------------------------------------------------------

    /**
     * @description Manages user-created polls and voting sessions.
     * @path /votings/{votingId}
     * @allow (read) Any user can read poll data.
     * @allow (create) Any authenticated user can create a new poll.
     * @allow (update) Only authenticated users can vote (update vote counts).
     * @deny (delete) Deletion is not allowed from the client-side.
     * @principle Publicly readable, but creation and voting are restricted to authenticated users.
     */
    match /votings/{votingId} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn(); 
        allow delete: if false;
    }

    // ------------------------------------------------------------------------
    // Collection: workshops
    // ------------------------------------------------------------------------

    /**
     * @description Stores car workshop information.
     * @path /workshops/{workshopId}
     * @allow (read) Any user can read workshop data.
     * @allow (create) An authenticated user can add a new workshop.
     * @deny (write) Data is managed by a trusted backend function, not by clients.
     * @principle Publicly readable, but write access is restricted to backend services.
     */
    match /workshops/{workshopId} {
      allow read: if true;
      allow create: if isSignedIn() && isRequestingUser('createdBy');
      allow update, delete: if false;
    }
    
    // ------------------------------------------------------------------------
    // Collection: workshopReviews
    // ------------------------------------------------------------------------
    /**
     * @description Manages user reviews for workshops.
     * @path /workshopReviews/{reviewId}
     * @allow (read) Anyone can read workshop reviews.
     * @allow (create) Any authenticated user can create a review.
     * @allow (update, delete) Only the user who created the review can modify or delete it.
     * @principle Publicly readable, but writing and modification are controlled.
     */
    match /workshopReviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && isRequestingUser('userId');
      allow update, delete: if isSignedIn() && isDocumentOwner(resource.data);
    }
  }
}
