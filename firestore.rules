
rules_version = '2';

/**
 * @file firestore.rules
 * @description Security rules for the AutoSphere Firestore database.
 *
 * @section Core Philosophy
 * This ruleset uses a combination of path-based ownership for strictly private data (userSettings)
 * and document-based ownership for public or semi-public data (posts, cars). This flat structure
 * for major collections improves query performance and scalability.
 *
 * @section Data Structure
 * - /users/{userId}: Public-facing user profile data.
 * - /cars/{carId}: Root collection for all cars. Ownership via 'userId' field.
 * - /posts/{postId}: Root collection for all posts. Ownership via 'authorId' field.
 * - /userSettings/{userId}: Strictly private user settings.
 * - /featuredCars/{date}: Public, read-only data for the 'Car of the Day'.
 *
 * @section Key Security Decisions
 * - Default Deny: All paths are closed by default. Access must be explicitly granted.
 * - User Listing Disabled: It is not possible to list all users in the application.
 * - Ownership via Field: For root collections, ownership is checked via a field in the document.
 */
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * Use for path-based ownership checks (e.g., userSettings).
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document via a path.
     * CRITICAL: Use for update/delete operations to prevent modifying non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if a user profile is public, allowing read access.
     */
    function isPublicProfile(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.profileVisibility == 'public';
    }

    /**
     * Validates that a required field in a new document matches the authenticated user's UID.
     * Use for create operations in root collections.
     */
    function isRequestingUser(field) {
      return isSignedIn() && request.resource.data[field] == request.auth.uid;
    }

    /**
     * Checks ownership of an existing document via a 'userId' or 'authorId' field.
     * Use for update/delete operations in root collections.
     */
    function isDocumentOwner(doc) {
      // Accommodates both 'userId' (for cars) and 'authorId' (for posts)
      return isSignedIn() && (request.auth.uid == doc.userId || request.auth.uid == doc.authorId || request.auth.uid == doc.sellerId);
    }
    
    /**
     * Validates required fields for a new post.
     */
    function isValidPost() {
        let data = request.resource.data;
        return data.title is string && data.title.size() > 0 &&
               data.content is string && data.content.size() > 0 &&
               isRequestingUser('authorId');
    }

    /**
     * Validates required fields for a new car.
     */
    function isValidCar() {
        let data = request.resource.data;
        return data.brand is string && data.brand.size() > 0 &&
               data.model is string && data.model.size() > 0 &&
               data.year is number && data.year > 1900 &&
               isRequestingUser('userId');
    }


    // ------------------------------------------------------------------------
    // Collection: users
    // ------------------------------------------------------------------------
    match /users/{userId} {
      allow get: if isOwner(userId) || (resource != null && resource.data.profileVisibility == 'public');
      allow list: if false; // Disallow listing all users
      allow create: if isOwner(userId) && isRequestingUser('id');
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    // ------------------------------------------------------------------------
    // Collection: posts (Root Collection)
    // ------------------------------------------------------------------------
    match /posts/{postId} {
      allow get, list: if true; // Posts are public
      allow create: if isSignedIn() && isValidPost();
      allow update: if isSignedIn() && isDocumentOwner(resource.data);
      allow delete: if isSignedIn() && isDocumentOwner(resource.data);

      // Subcollection: comments
      match /comments/{commentId} {
        allow read, list: if true;
        allow create: if isSignedIn() && isRequestingUser('authorId');
        allow update, delete: if isSignedIn() && isDocumentOwner(resource.data);
      }
    }
    
    // ------------------------------------------------------------------------
    // Collection: cars (Root Collection)
    // ------------------------------------------------------------------------
    match /cars/{carId} {
      allow get, list: if true; // Allow anyone to read car data
      allow create: if isSignedIn() && isValidCar();
      allow update: if isSignedIn() && isDocumentOwner(resource.data);
      allow delete: if isSignedIn() && isDocumentOwner(resource.data);
    }

    // ------------------------------------------------------------------------
    // Collection: marketplace (Root Collection)
    // ------------------------------------------------------------------------
    match /marketplace/{itemId} {
      allow read, list: if true; // Listings are public
      allow create: if isSignedIn() && isRequestingUser('sellerId');
      allow update: if isSignedIn() && isDocumentOwner(resource.data);
      allow delete: if isSignedIn() && isDocumentOwner(resource.data);
    }


    // ------------------------------------------------------------------------
    // Collection: comments (Root Collection for queries)
    // ------------------------------------------------------------------------
     match /comments/{commentId} {
        allow read: if true;
        allow create: if isSignedIn() && isRequestingUser('authorId');
        allow update, delete: if isSignedIn() && isDocumentOwner(resource.data);
    }

    // ------------------------------------------------------------------------
    // Collection: featuredCars
    // ------------------------------------------------------------------------
    match /featuredCars/{date} {
      allow get, list: if true;
      allow create, update, delete: if false; // Managed by backend
    }

    // ------------------------------------------------------------------------
    // Collection: userSettings
    // ------------------------------------------------------------------------
    match /userSettings/{userId} {
      allow get, list, create, update, delete: if isOwner(userId);
    }
    
    // ------------------------------------------------------------------------
    // Collection: votings
    // ------------------------------------------------------------------------
    match /votings/{votingId} {
        allow read: if true;
        allow create: if isSignedIn();
        // Allow update only to vote (not change question etc.)
        allow update: if isSignedIn() && request.resource.data.keys().hasOnly(['votes', 'votedUserIds', 'totalVotes']); 
        allow delete: if false; // Deletion via backend function
    }

    // ------------------------------------------------------------------------
    // Collection: workshops
    // ------------------------------------------------------------------------
    match /workshops/{workshopId} {
      allow read: if true;
      allow create: if isSignedIn() && isRequestingUser('createdBy');
      allow update, delete: if false; // Managed by backend
    }
    
    // ------------------------------------------------------------------------
    // Collection: workshopReviews
    // ------------------------------------------------------------------------
    match /workshopReviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && isRequestingUser('userId');
      allow update, delete: if isSignedIn() && isDocumentOwner(resource.data);
    }
    
    // ------------------------------------------------------------------------
    // Collection: dialogs & messages (Private Chat)
    // ------------------------------------------------------------------------
    match /dialogs/{dialogId} {
       allow read, write: if isSignedIn() && request.auth.uid in resource.data.participantIds;
    }

    match /messages/{messageId} {
       allow read: if isSignedIn() && get(/databases/$(database)/documents/dialogs/$(resource.data.dialogId)).data.participantIds.hasAny([request.auth.uid]);
       allow create: if isSignedIn() && isRequestingUser('authorId');
       allow update, delete: if false; // Messages are immutable
    }

    // ------------------------------------------------------------------------
    // Collection: feedback
    // ------------------------------------------------------------------------
    match /feedback/{feedbackId} {
      allow create: if true; // Anyone can submit feedback
      allow read, update, delete: if false; // Read by backend only
    }
    
    // ------------------------------------------------------------------------
    // Collection: autoNews
    // ------------------------------------------------------------------------
    match /autoNews/{newsId} {
      allow read: if true;
      allow write: if false; // Managed by backend
    }
  }
}
